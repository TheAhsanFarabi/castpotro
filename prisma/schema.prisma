// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql" // Change to "postgresql" or "sqlite" if needed
  url      = env("DATABASE_URL")
}

// --------------------------------------
// 1. USER & ROLES
// --------------------------------------

enum Role {
  USER
  SUPER_ADMIN
  INSTRUCTOR
  COMMUNITY_MANAGER
  PARTNER_MANAGER
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  age         String?
  password    String
  role        Role         @default(USER)
  coins       Int          @default(100) // Starting balance
  xp          Int          @default(0)
  bio          String?   @db.Text
  location     String?
  avatarConfig Json?     
  bannerConfig Json?
  
  // Relations
  enrollments Enrollment[]
  applications Application[]
  eventRegistrations EventRegistration[]
  questSubmissions QuestSubmission[]
  notifications      Notification[]     
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

// --------------------------------------
// 2. LMS CORE (Courses -> Units -> Lessons)
// --------------------------------------

model Course {
  id          String       @id @default(cuid())
  title       String
  description String
  icon        String       @default("Hexagon") // Lucide icon name
  units       Unit[]
  enrollments Enrollment[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Unit {
  id          String   @id @default(cuid())
  title       String
  description String
  order       Int      // 1, 2, 3... used for sequencing
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
}

model Lesson {
  id               String            @id @default(cuid())
  title            String
  videoUrl         String?
  theory           String            @db.Text // Long text for interactive theory
  unitId           String
  unit             Unit              @relation(fields: [unitId], references: [id], onDelete: Cascade)
  questions        Quiz[]
  
  // Reverse relation to track who completed this specific lesson
  completedBy      CompletedLesson[] 
}

model Quiz {
  id        String   @id @default(cuid())
  question  String
  options   Json     // Stored as ["Option A", "Option B", "Option C"]
  correct   Int      // Index of the correct option (0, 1, 2...)
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// 3. PROGRESS TRACKING (The "Lock" Logic)
// --------------------------------------

model Enrollment {
  id               String            @id @default(cuid())
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId         String
  course           Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Tracks exactly which lessons are finished in this course
  completedLessons CompletedLesson[] 
  
  progress         Int               @default(0) // Percentage (optional helper)
  createdAt        DateTime          @default(now())

  @@unique([userId, courseId]) // User can only enroll in a course once
}

model CompletedLesson {
  id           String     @id @default(cuid())
  enrollmentId String
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lessonId     String
  lesson       Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  completedAt  DateTime   @default(now())

  @@unique([enrollmentId, lessonId]) // Prevent duplicate completions
}

// --------------------------------------
// 4. COMMUNITY (Events & Quests)
// --------------------------------------

model Event {
  id          String   @id @default(cuid())
  title       String
  description String
  date        DateTime
  location    String
  type        String   
  capacity    Int      @default(50)
  
  // NEW FIELD
  meetingLink String?  @db.Text 
  status      String   @default("UPCOMING") // Options: UPCOMING, COMPLETED, CANCELLED

  // RELATIONS
  registrations EventRegistration[]
  
  createdAt   DateTime @default(now())
}

// NEW MODEL: Event Registration
model EventRegistration {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([eventId, userId]) // User can only register once
}

// NEW MODEL: Notification
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String   @default("INFO") // INFO, EVENT, ALERT
  link      String?  // Action link (e.g., zoom link)
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

// --------------------------------------
// 5. CAREER & ADS (Jobs & monetization)
// --------------------------------------

model Job {
  id             String        @id @default(cuid())
  role           String
  company        String
  location       String
  salary         String
  type           String        // "Full-Time", "Internship"
  requiredCourse String?       // ID of the course required to apply
  isPromoted     Boolean       @default(false)
  isOpen         Boolean       @default(true) // New field: true = showing, false = hired/closed
  createdAt      DateTime      @default(now())
  
  applications   Application[] // Add this relation
}

model Application {
  id        String   @id @default(cuid())
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  status    String   @default("PENDING") // PENDING, HIRED, REJECTED
  createdAt DateTime @default(now())

  @@unique([jobId, userId]) // User can only apply once to a job
}

model Ad {
  id          String   @id @default(cuid())
  title       String
  content     String
  ctaLink     String
  isActive    Boolean  @default(true)
  placement   String   // "sidebar_right", "banner_top"
  createdAt   DateTime @default(now())
}

// --- QUESTS & IMPACT SYSTEM ---

model Quest {
  id               String   @id @default(cuid())
  title            String
  description      String
  xp               Int
  sdgId            Int      // 1-17 corresponding to UN SDGs
  
  // Configuration
  frequency        String   @default("ONCE") // "DAILY", "WEEKLY", "ONCE", "INFINITE"
  verificationType String   @default("TEXT") // "AI_IMAGE", "TEXT", "LINK", "QR"
  
  // AI Configuration
  aiPrompt         String?  @db.Text // e.g., "Check if the image contains a planted tree"
  
  submissions      QuestSubmission[]
  
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model QuestSubmission {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  questId      String
  quest        Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)
  
  // Evidence
  proofText    String?  @db.Text // User's reflection or link
  proofImage   String?  // URL to uploaded image
  
  // Validation Status
  status       String   @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  
  // Feedback
  feedback     String?  // Reason for rejection (from AI or Admin)
  aiConfidence Float?   // 0.0 to 1.0 (if AI verified)

  createdAt    DateTime @default(now())

  // Indexes for faster analytics
  @@index([userId])
  @@index([questId])
}